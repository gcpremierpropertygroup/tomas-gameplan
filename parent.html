<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#06060f">
<title>TG Parent Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#06060f;--surface:rgba(255,255,255,.03);--surface2:rgba(255,255,255,.055);--surface3:rgba(255,255,255,.09);
  --neon:#00e5ff;--neon-glow:rgba(0,229,255,.18);--neon-soft:rgba(0,229,255,.08);
  --fire:#ff4757;--fire-glow:rgba(255,71,87,.15);
  --gold:#ffc312;--gold-glow:rgba(255,195,18,.12);
  --mint:#0be881;--mint-glow:rgba(11,232,129,.15);
  --purple:#a855f7;--purple-glow:rgba(168,85,247,.12);
  --text:#eef0ff;--text2:#7a7da8;--text3:#484b6a;
  --border:rgba(255,255,255,.06);
  --glass:rgba(15,15,30,.65);--glass-border:rgba(255,255,255,.08);
  --radius:18px;
}
body{
  font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);
  min-height:100vh;min-height:100dvh;overflow-x:hidden;
  background-image:
    radial-gradient(ellipse 80% 60% at 50% 0%, rgba(0,229,255,.04) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 100%, rgba(168,85,247,.03) 0%, transparent 50%);
}

.header{padding:24px 20px 16px;display:flex;align-items:center;gap:14px}
.header-icon{
  width:48px;height:48px;border-radius:14px;
  background:linear-gradient(135deg,var(--neon),var(--purple));
  display:flex;align-items:center;justify-content:center;
  font-family:'Space Mono',monospace;font-size:16px;font-weight:700;color:#fff;
  box-shadow:0 4px 20px rgba(0,229,255,.25);
}
.header h1{font-size:22px;font-weight:700;letter-spacing:-.02em}
.header .sub{font-size:13px;color:var(--text2);margin-top:2px}

.sync-bar{padding:0 20px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--mint);animation:pulse 2s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.sync-text{font-size:12px;color:var(--text2)}
.refresh-btn{
  margin-left:auto;padding:6px 14px;border-radius:20px;border:1px solid var(--border);
  background:var(--surface);color:var(--text2);font-size:12px;font-family:inherit;cursor:pointer;transition:all .2s;
}
.refresh-btn:hover{background:var(--surface2);color:var(--text)}
.refresh-btn:active{transform:scale(.96)}

.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:0 16px;margin-bottom:20px}
.stat-card{
  background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);border-radius:14px;padding:14px 10px;text-align:center;
}
.stat-num{font-size:28px;font-weight:800;font-family:'Space Mono',monospace;line-height:1}
.stat-label{font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--text2);margin-top:6px}
.stat-overdue .stat-num{color:var(--fire)}
.stat-pending .stat-num{color:var(--gold)}
.stat-progress .stat-num{color:var(--neon)}
.stat-done .stat-num{color:var(--mint)}

.section{padding:0 16px;margin-bottom:24px}
.section-title{
  font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;
  color:var(--text2);margin-bottom:12px;display:flex;align-items:center;gap:8px;
}
.section-title .dot{width:6px;height:6px;border-radius:50%}

/* Big 3 Card */
.big3-card{
  background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);border-radius:var(--radius);padding:18px;
}
.big3-date{font-size:11px;color:var(--text3);margin-bottom:14px;font-weight:600;letter-spacing:.05em;text-transform:uppercase}
.big3-item{
  display:flex;align-items:center;gap:12px;padding:10px 0;
  border-bottom:1px solid var(--border);
}
.big3-item:last-child{border-bottom:none}
.big3-num{
  width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:800;font-family:'Space Mono',monospace;flex-shrink:0;
}
.big3-num.n1{background:rgba(255,71,87,.15);color:var(--fire)}
.big3-num.n2{background:rgba(255,195,18,.12);color:var(--gold)}
.big3-num.n3{background:rgba(0,229,255,.08);color:var(--neon)}
.big3-text{font-size:14px;font-weight:500;flex:1;line-height:1.3}
.big3-check{font-size:16px;flex-shrink:0}
.big3-empty{font-size:13px;color:var(--text3);text-align:center;padding:20px 0}

/* Day Group */
.day-group{margin-bottom:18px}
.day-header{
  display:flex;align-items:center;gap:10px;margin-bottom:10px;
}
.day-label{
  font-size:13px;font-weight:700;letter-spacing:.02em;
}
.day-label.overdue-day{color:var(--fire)}
.day-label.today-day{color:var(--neon)}
.day-label.future-day{color:var(--text)}
.day-line{flex:1;height:1px;background:var(--border)}
.day-count{font-size:11px;color:var(--text3);font-weight:600}

/* HW Cards */
.hw-card{
  background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);border-radius:14px;padding:14px 16px;
  margin-bottom:8px;display:flex;align-items:center;gap:12px;
}
.hw-status-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.hw-status-dot.overdue{background:var(--fire);box-shadow:0 0 6px rgba(255,71,87,.4)}
.hw-status-dot.pending{background:var(--gold)}
.hw-status-dot.in-progress{background:var(--neon);box-shadow:0 0 6px rgba(0,229,255,.3)}
.hw-status-dot.done{background:var(--mint)}
.hw-card-body{flex:1;min-width:0}
.hw-name{font-size:14px;font-weight:600;line-height:1.3}
.hw-name.done-name{text-decoration:line-through;opacity:.45}
.hw-meta{font-size:11px;color:var(--text2);margin-top:3px}
.hw-badge{font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;padding:3px 9px;border-radius:20px;white-space:nowrap;flex-shrink:0}
.badge-overdue{background:var(--fire-glow);color:var(--fire);border:1px solid rgba(255,71,87,.2)}
.badge-pending{background:var(--gold-glow);color:var(--gold);border:1px solid rgba(255,195,18,.2)}
.badge-in-progress{background:var(--neon-soft);color:var(--neon);border:1px solid rgba(0,229,255,.15)}
.badge-done{background:var(--mint-glow);color:var(--mint);border:1px solid rgba(11,232,129,.2)}
.hw-meta{display:flex;gap:12px;flex-wrap:wrap}
.hw-meta span{font-size:12px;color:var(--text2);display:flex;align-items:center;gap:4px}

/* Activity Feed */
.activity-item{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.activity-item:last-child{border-bottom:none}
.activity-icon{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.activity-icon.added{background:var(--mint-glow);color:var(--mint)}
.activity-icon.completed{background:var(--gold-glow);color:var(--gold)}
.activity-icon.deleted{background:var(--fire-glow);color:var(--fire)}
.activity-icon.status_change{background:var(--neon-soft);color:var(--neon)}
.activity-icon.other{background:var(--surface2);color:var(--text2)}
.activity-text{flex:1;font-size:13px;line-height:1.4}
.activity-text strong{font-weight:600}
.activity-time{font-size:11px;color:var(--text3);margin-top:2px}

.empty-state{text-align:center;padding:60px 20px;color:var(--text3)}
.empty-state .icon{font-size:48px;margin-bottom:16px}
.empty-state p{font-size:14px;line-height:1.5}

.loading{text-align:center;padding:80px 20px}
.spinner{width:40px;height:40px;border:3px solid var(--surface3);border-top-color:var(--neon);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{color:var(--text2);font-size:14px}

.error-state{text-align:center;padding:60px 20px;color:var(--fire)}
.error-state p{font-size:14px;margin-top:8px;color:var(--text2)}

.bottom-spacer{height:40px}

/* HW Detail Drawer */
.hw-card{cursor:pointer;transition:all .2s}
.hw-card:active{transform:scale(.98);background:rgba(255,255,255,.06)}
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:100;opacity:0;pointer-events:none;transition:opacity .25s}
.drawer-overlay.show{opacity:1;pointer-events:all}
.drawer{position:fixed;bottom:0;left:0;right:0;background:#0f0f1e;border-top:1px solid rgba(255,255,255,.1);border-radius:24px 24px 0 0;z-index:101;padding:0 20px 40px;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);max-height:85vh;overflow-y:auto}
.drawer.show{transform:translateY(0)}
.drawer-handle{width:36px;height:4px;background:rgba(255,255,255,.15);border-radius:2px;margin:12px auto 20px}
.drawer-subject-badge{display:inline-block;font-size:11px;font-weight:700;padding:4px 12px;border-radius:20px;background:rgba(168,85,247,.15);color:var(--purple);border:1px solid rgba(168,85,247,.2);margin-bottom:14px;letter-spacing:.5px;text-transform:uppercase}
.drawer-name{font-size:22px;font-weight:800;line-height:1.25;letter-spacing:-.3px;margin-bottom:18px}
.drawer-name.done-name{text-decoration:line-through;opacity:.5}
.drawer-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
.drawer-cell{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:14px}
.drawer-cell-lbl{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}
.drawer-cell-val{font-size:15px;font-weight:700;color:var(--text)}
.drawer-status-row{display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:14px;margin-bottom:16px}
.drawer-close{width:100%;padding:14px;border:1px solid rgba(255,255,255,.1);border-radius:14px;background:transparent;color:var(--text2);font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.3px;transition:all .2s}
.drawer-close:active{background:rgba(255,255,255,.06)}

@media(max-width:400px){.stats{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>

<div class="header">
  <div class="header-icon">TG</div>
  <div>
    <h1>Tomas Tracker</h1>
    <div class="sub">Parent Dashboard</div>
  </div>
</div>

<div class="sync-bar">
  <div class="sync-dot" id="syncDot"></div>
  <span class="sync-text" id="syncText">Connecting...</span>
  <button class="refresh-btn" onclick="fetchData()">Refresh</button>
</div>

<div id="app">
  <div class="loading">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>
</div>

<div class="bottom-spacer"></div>

<script>
const SCRIPT_URL = localStorage.getItem('tg_parent_url') || 'https://script.google.com/macros/s/AKfycbz_eRMrzLYxS90D_k9gAaMHfLCs0mpyr0VLvPluT-WmbIKztTLU_EUmzVK8Wc27wkQ/exec';

function $(s){return document.querySelector(s)}

function getStatusInfo(hw) {
  const today = new Date().toISOString().slice(0,10);
  const status = (hw.status || 'not-started').toLowerCase();
  if (status === 'done') return {cls:'done', badge:'Done', badgeCls:'badge-done'};
  if (status === 'in-progress') return {cls:'in-progress', badge:'In Progress', badgeCls:'badge-in-progress'};
  if (hw.due && hw.due < today) return {cls:'overdue', badge:'Overdue', badgeCls:'badge-overdue'};
  return {cls:'pending', badge:'To Do', badgeCls:'badge-pending'};
}

function formatDue(due) {
  if (!due || due === 'Invalid Date') return '';
  try {
    const d = new Date(due + 'T00:00:00');
    if (isNaN(d.getTime())) return '';
    const today = new Date(); today.setHours(0,0,0,0);
    const diff = Math.round((d - today) / 86400000);
    if (diff < 0) return Math.abs(diff) + 'd overdue';
    if (diff === 0) return 'Today';
    if (diff === 1) return 'Tomorrow';
    return d.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
  } catch(e) { return ''; }
}

function formatTime(ts) {
  if (!ts) return '';
  try {
    const d = new Date(ts);
    if (isNaN(d.getTime())) return '';
    const today = new Date(); today.setHours(0,0,0,0);
    const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
    const itemDay = new Date(d); itemDay.setHours(0,0,0,0);
    const timeStr = d.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit', hour12:true});
    if (itemDay.getTime() === today.getTime()) return 'Today at ' + timeStr;
    if (itemDay.getTime() === yesterday.getTime()) return 'Yesterday at ' + timeStr;
    return d.toLocaleDateString('en-US', {month:'short', day:'numeric'}) + ' at ' + timeStr;
  } catch(e) { return ''; }
}

function actionIcon(action) {
  if (action === 'added') return '+';
  if (action === 'completed') return '‚úì';
  if (action === 'deleted') return '‚úï';
  if (action === 'status_change') return '‚Üª';
  return '‚Ä¢';
}

function actionText(item) {
  const name = '<strong>' + escHtml(item.name || 'Unknown') + '</strong>';
  if (item.action === 'added') return name + ' was added';
  if (item.action === 'completed') return name + ' marked complete';
  if (item.action === 'deleted') return name + ' was removed';
  if (item.action === 'status_change') return name + ' ‚Üí ' + escHtml(item.status || '');
  return name + ' updated';
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderBig3(dailyGoals) {
  const todayKey = new Date().toISOString().slice(0,10);
  // Find today's goals - dailyGoals is array of {date, goal1, goal2, goal3, checks}
  const todayGoals = (dailyGoals || []).find(g => g.date === todayKey);

  let html = '<div class="section">';
  html += '<div class="section-title"><span class="dot" style="background:var(--purple)"></span>Today\'s Big 3</div>';
  html += '<div class="big3-card">';

  if (!todayGoals) {
    html += '<div class="big3-empty">No goals set yet today</div>';
  } else {
    const goals = [todayGoals.goal1, todayGoals.goal2, todayGoals.goal3];
    const checks = todayGoals.checks ? String(todayGoals.checks).split('') : [];
    const numClasses = ['n1','n2','n3'];
    goals.forEach((g, i) => {
      if (!g) return;
      const done = checks[i] === '1';
      html += '<div class="big3-item">';
      html += '<div class="big3-num ' + numClasses[i] + '">' + (i+1) + '</div>';
      html += '<div class="big3-text" style="' + (done ? 'text-decoration:line-through;opacity:.5' : '') + '">' + escHtml(g) + '</div>';
      html += '<div class="big3-check">' + (done ? '‚úÖ' : '‚¨ú') + '</div>';
      html += '</div>';
    });
  }

  html += '</div></div>';
  return html;
}

function renderDashboard(data) {
  const hw = data.homework || [];
  const activity = (data.activity || []).filter(a => {
    // Filter out big3_locked events ‚Äî they have their own section
    return a.action !== 'big3_locked';
  });
  const dailyGoals = data.dailyGoals || [];

  const today = new Date().toISOString().slice(0,10);
  let overdue=0, pending=0, inProgress=0, done=0;
  hw.forEach(h => {
    const s = (h.status||'not-started').toLowerCase();
    if (s === 'done') { done++; return; }
    if (s === 'in-progress') inProgress++; else pending++;
    if (h.due && h.due < today) overdue++;
  });



  let html = '';

  // Stats
  html += '<div class="stats">';
  html += '<div class="stat-card stat-overdue"><div class="stat-num">' + overdue + '</div><div class="stat-label">Overdue</div></div>';
  html += '<div class="stat-card stat-pending"><div class="stat-num">' + pending + '</div><div class="stat-label">To Do</div></div>';
  html += '<div class="stat-card stat-progress"><div class="stat-num">' + inProgress + '</div><div class="stat-label">Doing</div></div>';
  html += '<div class="stat-card stat-done"><div class="stat-num">' + done + '</div><div class="stat-label">Done</div></div>';
  html += '</div>';

  // Today's Big 3
  html += renderBig3(dailyGoals);

  // Homework grouped by due date
  if (hw.length > 0) {
    // Group all hw by due date
    const groups = {};
    hw.forEach(h => {
      const key = h.due || 'no-date';
      if (!groups[key]) groups[key] = [];
      groups[key].push(h);
    });
    // Sort keys: overdue first, then ascending, no-date last
    const sortedKeys = Object.keys(groups).sort((a,b) => {
      if (a === 'no-date') return 1;
      if (b === 'no-date') return -1;
      return a < b ? -1 : 1;
    });

    html += '<div class="section">';
    html += '<div class="section-title"><span class="dot" style="background:var(--gold)"></span>Homework by Day</div>';

    sortedKeys.forEach(key => {
      const items = groups[key];
      const isNoDate = key === 'no-date';
      const isOverdue = !isNoDate && key < today;
      const isToday = key === today;

      // Day header label
      let dayLabel = 'No Due Date';
      if (!isNoDate) {
        const d = new Date(key + 'T12:00:00');
        const diff = Math.round((d - new Date(today + 'T12:00:00')) / 86400000);
        if (diff < 0) dayLabel = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}) + ' ‚Äî ' + Math.abs(diff) + 'd overdue';
        else if (diff === 0) dayLabel = 'Today ‚Äî ' + d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
        else if (diff === 1) dayLabel = 'Tomorrow ‚Äî ' + d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
        else dayLabel = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
      }

      const labelCls = isOverdue ? 'overdue-day' : isToday ? 'today-day' : 'future-day';
      const doneCount = items.filter(h => (h.status||'').toLowerCase() === 'done').length;

      html += '<div class="day-group">';
      html += '<div class="day-header">';
      html += '<div class="day-label ' + labelCls + '">' + dayLabel + '</div>';
      html += '<div class="day-line"></div>';
      html += '<div class="day-count">' + doneCount + '/' + items.length + ' done</div>';
      html += '</div>';

      // Sort within day: not-done first, done last
      const dayItems = [...items].sort((a,b) => {
        const aDone = (a.status||'').toLowerCase() === 'done' ? 1 : 0;
        const bDone = (b.status||'').toLowerCase() === 'done' ? 1 : 0;
        return aDone - bDone;
      });

      dayItems.forEach(h => {
        const info = getStatusInfo(h);
        const isDone = info.cls === 'done';
        const hwJson = escHtml(JSON.stringify(h));
        html += '<div class="hw-card" onclick=\'openHWDrawer(' + JSON.stringify(h) + ')\'>';
        html += '<div class="hw-status-dot ' + info.cls + '"></div>';
        html += '<div class="hw-card-body">';
        html += '<div class="hw-name' + (isDone ? ' done-name' : '') + '">' + escHtml(h.name||'Untitled') + '</div>';
        const meta = [h.subject ? 'üìö '+escHtml(h.subject) : '', h.priority ? '‚ö° '+escHtml(h.priority) : ''].filter(Boolean).join(' ¬∑ ');
        if (meta) html += '<div class="hw-meta">' + meta + '</div>';
        html += '</div>';
        html += '<span class="hw-badge ' + info.badgeCls + '">' + info.badge + ' ‚Ä∫</span>';
        html += '</div>';
      });

      html += '</div>';
    });

    html += '</div>';
  }

  // Cancelled HW log
  const cancelled = data.cancelled || [];
  if (cancelled.length > 0) {
    html += '<div class="section">';
    html += '<div class="section-title"><span class="dot" style="background:var(--fire)"></span>Cancelled (' + cancelled.length + ')</div>';
    cancelled.forEach(h => {
      html += '<div class="hw-card" style="opacity:.7">';
      html += '<div class="hw-status-dot" style="background:var(--fire)"></div>';
      html += '<div class="hw-card-body">';
      html += '<div class="hw-name done-name">' + escHtml(h.name||'Untitled') + '</div>';
      const meta = [
        h.subject ? 'üìö '+escHtml(h.subject) : '',
        h.due ? 'üìÖ Due '+formatDue(h.due) : '',
        h.reason ? 'üí¨ '+escHtml(h.reason) : ''
      ].filter(Boolean).join(' ¬∑ ');
      if (meta) html += '<div class="hw-meta">' + meta + '</div>';
      html += '<div class="hw-meta" style="margin-top:2px;color:var(--text3)">' + formatTime(h.timestamp) + '</div>';
      html += '</div>';
      html += '<span class="hw-badge badge-overdue">Cancelled</span>';
      html += '</div>';
    });
    html += '</div>';
  }

  // Activity Feed ‚Äî homework events only
  if (activity.length > 0) {
    html += '<div class="section">';
    html += '<div class="section-title"><span class="dot" style="background:var(--neon)"></span>Recent Activity</div>';
    activity.slice(0,12).forEach(item => {
      const action = (item.action||'other').toLowerCase();
      const iconCls = ['added','completed','deleted','status_change'].includes(action) ? action : 'other';
      html += '<div class="activity-item">';
      html += '<div class="activity-icon ' + iconCls + '">' + actionIcon(action) + '</div>';
      html += '<div><div class="activity-text">' + actionText(item) + '</div>';
      html += '<div class="activity-time">' + formatTime(item.timestamp) + '</div></div>';
      html += '</div>';
    });
    html += '</div>';
  }

  if (hw.length === 0 && activity.length === 0 && dailyGoals.length === 0) {
    html += '<div class="empty-state"><div class="icon">üìã</div>';
    html += '<p>Nothing tracked yet.<br>Data will appear here once Tomas uses the app.</p></div>';
  }

  $('#app').innerHTML = html;
}

async function fetchData() {
  if (!SCRIPT_URL) { showSetup(); return; }

  $('#syncDot').style.background = 'var(--gold)';
  $('#syncText').textContent = 'Syncing...';

  try {
    const resp = await fetch(SCRIPT_URL);
    const data = await resp.json();
    if (data.status === 'ok') {
      renderDashboard(data);
      $('#syncDot').style.background = 'var(--mint)';
      const d = data.fetchedAt ? new Date(data.fetchedAt) : new Date();
      const timeStr = isNaN(d.getTime()) ? 'just now' : d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
      $('#syncText').textContent = 'Updated ' + timeStr;
    } else {
      showError(data.message || 'Unknown error');
    }
  } catch(e) {
    showError('Could not connect. Try refreshing.');
    console.error('Fetch error:', e);
  }
}

function showError(msg) {
  $('#syncDot').style.background = 'var(--fire)';
  $('#syncText').textContent = 'Connection error';
  $('#app').innerHTML = '<div class="error-state"><div style="font-size:36px">‚ö†Ô∏è</div><p>' + escHtml(msg) + '</p></div>';
}

function showSetup() {
  $('#app').innerHTML = `
    <div style="background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);padding:24px;margin:20px 16px;text-align:center">
      <p style="font-size:14px;color:var(--text2);margin-bottom:16px;line-height:1.5">Paste your Apps Script URL to connect.</p>
      <input type="text" id="urlInput" placeholder="https://script.google.com/macros/s/..."
        style="width:100%;padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-family:inherit;font-size:14px;margin-bottom:12px;outline:none">
      <button onclick="saveUrl()"
        style="width:100%;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--neon),var(--purple));color:#fff;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer">
        Connect
      </button>
    </div>`;
}

function saveUrl() {
  const url = document.getElementById('urlInput').value.trim();
  if (url) { localStorage.setItem('tg_parent_url', url); location.reload(); }
}

// Refresh every 2 minutes
setInterval(fetchData, 120000);

// Refresh when tab becomes visible (user switches back to this tab)
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) fetchData();
});

fetchData();

/* ===== HW DETAIL DRAWER ===== */
(function(){
  // Inject drawer DOM
  document.body.insertAdjacentHTML('beforeend', `
    <div class="drawer-overlay" id="drawerOverlay"></div>
    <div class="drawer" id="hwDrawer">
      <div class="drawer-handle"></div>
      <div id="drawerContent"></div>
      <button class="drawer-close" onclick="closeDrawer()">Close</button>
    </div>
  `);

  window.openHWDrawer = function(hw) {
    const isDone = (hw.status||'').toLowerCase() === 'done';
    const isOverdue = hw.due && hw.due < new Date().toISOString().slice(0,10) && !isDone;
    const statusColors = {
      'done':        {bg:'rgba(11,232,129,.1)', color:'var(--mint)',   label:'‚úÖ Done'},
      'in progress': {bg:'rgba(0,229,255,.08)', color:'var(--neon)',   label:'‚ö° In Progress'},
      'overdue':     {bg:'rgba(255,71,87,.1)',  color:'var(--fire)',   label:'üî¥ Overdue'},
      'to do':       {bg:'rgba(255,195,18,.1)', color:'var(--gold)',   label:'üìã To Do'},
    };
    const statusKey = isOverdue ? 'overdue' : (hw.status||'to do').toLowerCase();
    const sc = statusColors[statusKey] || statusColors['to do'];

    const priLabel = hw.priority == 1 ? 'üî¥ P1 ‚Äî Critical' : hw.priority == 2 ? 'üü° P2 ‚Äî Important' : hw.priority == 3 ? 'üü¢ P3 ‚Äî Normal' : '‚Äî';
    const dueLabel = hw.due ? new Date(hw.due + 'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'}) : 'No due date set';
    const addedLabel = hw.added ? new Date(hw.added + 'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '‚Äî';

    document.getElementById('drawerContent').innerHTML = `
      ${hw.subject ? `<div class="drawer-subject-badge">üìö ${escHtml(hw.subject)}</div>` : ''}
      <div class="drawer-name${isDone?' done-name':''}">${escHtml(hw.name||'Untitled')}</div>
      <div class="drawer-status-row" style="background:${sc.bg};border:1px solid ${sc.color}22">
        <span style="font-size:18px">${sc.label.split(' ')[0]}</span>
        <span style="font-size:14px;font-weight:700;color:${sc.color}">${sc.label.split(' ').slice(1).join(' ')}</span>
      </div>
      <div class="drawer-grid">
        <div class="drawer-cell">
          <div class="drawer-cell-lbl">Due Date</div>
          <div class="drawer-cell-val" style="${isOverdue?'color:var(--fire)':''}">${dueLabel}</div>
        </div>
        <div class="drawer-cell">
          <div class="drawer-cell-lbl">Priority</div>
          <div class="drawer-cell-val">${priLabel}</div>
        </div>
        <div class="drawer-cell">
          <div class="drawer-cell-lbl">Subject</div>
          <div class="drawer-cell-val">${escHtml(hw.subject||'‚Äî')}</div>
        </div>
        <div class="drawer-cell">
          <div class="drawer-cell-lbl">Added</div>
          <div class="drawer-cell-val">${addedLabel}</div>
        </div>
      </div>
    `;
    document.getElementById('drawerOverlay').classList.add('show');
    document.getElementById('hwDrawer').classList.add('show');
  };

  window.closeDrawer = function() {
    document.getElementById('drawerOverlay').classList.remove('show');
    document.getElementById('hwDrawer').classList.remove('show');
  };

  document.getElementById('drawerOverlay').addEventListener('click', closeDrawer);
})();
</script>
</body>
</html>
